name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    # Don't review bot PRs to prevent loops
    if: github.event.pull_request.user.login != 'github-actions[bot]'

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        run: |
          # Get list of changed files
          FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only | head -20)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get diff content
        id: diff
        run: |
          # Get the actual diff (limited size)
          DIFF=$(gh pr diff ${{ github.event.pull_request.number }} | head -500)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: AI Code Review
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const https = require('https');

            const pr = context.payload.pull_request;
            const files = `${{ steps.changed.outputs.files }}`;
            const diff = `${{ steps.diff.outputs.diff }}`;

            const systemPrompt = `You are a code reviewer for Claw Academy, an AI agent skill marketplace.

            Project context:
            - Built with Next.js 14, TypeScript, Tailwind CSS
            - Uses Supabase for database
            - Follows TDD methodology
            - Modular architecture with @clawacademy/* packages

            Review guidelines:
            1. Check for bugs and logic errors
            2. Check for security issues (XSS, injection, etc.)
            3. Check TypeScript types
            4. Check for performance issues
            5. Suggest improvements (but be concise)

            Format your review as:
            ## Summary
            Brief overview of the changes

            ## Issues Found
            - ðŸ”´ **Critical**: [if any]
            - ðŸŸ¡ **Warning**: [if any]
            - ðŸ”µ **Suggestion**: [if any]

            ## Verdict
            âœ… Approved / âš ï¸ Needs Changes / âŒ Request Changes

            Be constructive and helpful. If the code looks good, say so briefly.
            If you find issues, be specific about the file and line.`;

            const userMessage = `Please review this PR:

            **Title:** ${pr.title}

            **Description:**
            ${pr.body || 'No description provided'}

            **Changed files:**
            ${files}

            **Diff:**
            \`\`\`diff
            ${diff}
            \`\`\``;

            const requestBody = JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 2048,
              system: systemPrompt,
              messages: [{ role: 'user', content: userMessage }]
            });

            const response = await new Promise((resolve, reject) => {
              const req = https.request({
                hostname: 'api.anthropic.com',
                path: '/v1/messages',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-api-key': process.env.ANTHROPIC_API_KEY,
                  'anthropic-version': '2023-06-01'
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(JSON.parse(data)));
              });
              req.on('error', reject);
              req.write(requestBody);
              req.end();
            });

            const review = response.content?.[0]?.text || 'Unable to generate review.';

            // Post review comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `## ðŸ¤– AI Code Review\n\n${review}\n\n---\n*This review was generated by ClawBot. Please verify suggestions before applying.*`
            });
