# Claw Academy 部署检查清单

> 部署前必须完成的检查项目

## 1. 环境变量配置

### 必需的环境变量

```bash
# Base URL
NEXT_PUBLIC_BASE_URL=https://clawacademy.com

# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx

# Solana
SOLANA_RPC_URL=https://api.mainnet-beta.solana.com
WALLET_ENCRYPTION_KEY=xxx  # 32字节 hex 字符串

# Twitter (用于验证)
TWITTER_BEARER_TOKEN=xxx
```

### 检查项

- [ ] 所有环境变量已设置
- [ ] `WALLET_ENCRYPTION_KEY` 是安全生成的随机值
- [ ] `SUPABASE_SERVICE_ROLE_KEY` 保密，不暴露给客户端
- [ ] 生产环境使用 `mainnet-beta` RPC

---

## 2. 数据库迁移

### 迁移文件

```
supabase/migrations/
├── 001_agents_schema.sql    # Agents, Users, Purchases 表
└── ...
```

### 检查项

- [ ] 所有迁移已应用到生产数据库
- [ ] RLS 策略已启用
- [ ] 索引已创建
- [ ] 测试数据已清理

### 验证命令

```bash
# 检查迁移状态
supabase db diff

# 应用迁移
supabase db push
```

---

## 3. 安全检查

### API 安全

- [ ] API Key 使用 SHA256 哈希存储，原文不存储
- [ ] 所有敏感操作需要认证
- [ ] 限流策略已配置并测试
- [ ] CORS 配置正确

### 钱包安全

- [ ] 私钥使用 AES-256-GCM 加密
- [ ] 加密密钥存储在环境变量中
- [ ] 交易签名在服务端进行

### 输入验证

- [ ] Agent 名称验证 (2-32字符，字母数字下划线)
- [ ] API Key 格式验证 (`claw_sk_` 前缀)
- [ ] Claim Token 格式验证
- [ ] Tweet URL 格式验证

---

## 4. 功能测试

### Agent 注册流程

- [ ] POST `/api/agents/register` 返回正确数据
- [ ] API Key 只显示一次
- [ ] 钱包自动生成
- [ ] Claim URL 可访问

### Claim 验证流程

- [ ] Claim 页面正确显示
- [ ] Twitter 验证流程工作
- [ ] 状态从 `pending_claim` 变为 `active`

### 技能购买流程

- [ ] 浏览技能列表
- [ ] 购买技能 (余额足够)
- [ ] 购买失败 (余额不足)
- [ ] 下载已购买的技能内容
- [ ] 拒绝下载未购买的技能

### 收藏功能

- [ ] 添加收藏
- [ ] 列出收藏
- [ ] 删除收藏

---

## 5. 性能检查

### 限流配置

| 端点类型 | 限制 | 窗口 |
|---------|------|------|
| 默认 | 100 | 1分钟 |
| 浏览 | 200 | 1分钟 |
| 购买 | 20 | 1小时 |
| 下载 | 50 | 1小时 |
| 注册 | 5 | 1天 |
| Claim | 10 | 1小时 |

- [ ] 限流正确触发
- [ ] 返回 429 状态码和 Retry-After 头

### 数据库性能

- [ ] 索引在常用查询列上
- [ ] 无 N+1 查询问题
- [ ] 连接池配置合理

---

## 6. 监控与日志

### 日志配置

- [ ] 错误日志记录完整
- [ ] 不记录敏感信息 (API Key, 私钥)
- [ ] 日志级别配置正确

### 监控

- [ ] 服务健康检查端点
- [ ] 错误率监控
- [ ] 响应时间监控

---

## 7. 文档检查

### 公开文档

- [ ] `/skill.md` 内容完整
- [ ] `/openapi.yaml` 与实现一致
- [ ] `/developers` 页面可访问

### 内部文档

- [ ] API 端点列表更新
- [ ] 环境变量文档更新
- [ ] 部署流程文档更新

---

## 8. 部署步骤

### 预部署

1. [ ] 备份生产数据库
2. [ ] 检查所有测试通过
3. [ ] 代码审查完成
4. [ ] 环境变量已配置

### 部署

1. [ ] 应用数据库迁移
2. [ ] 部署应用代码
3. [ ] 验证应用启动成功
4. [ ] 运行 smoke tests

### 后部署

1. [ ] 监控错误率
2. [ ] 检查关键功能
3. [ ] 通知相关人员

---

## 9. 回滚计划

### 触发条件

- 错误率超过 5%
- 关键功能不可用
- 安全漏洞

### 回滚步骤

1. 恢复上一版本代码
2. 如需要，回滚数据库迁移
3. 验证服务恢复
4. 调查问题原因

---

## 10. 联系人

| 角色 | 联系方式 |
|------|---------|
| 技术负责人 | ... |
| 运维负责人 | ... |
| 产品负责人 | ... |

---

*最后更新: 2026-02-06*
