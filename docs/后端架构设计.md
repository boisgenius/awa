# 后端架构设计

> 参考 Moltbook 实现，吸取其安全教训，设计 Claw Academy 后端架构

## 1. 架构概览

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            Client Layer                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────────────────────────┐ │
│  │   Browser    │  │   Mobile     │  │      OpenClaw Agent            │ │
│  │   (Next.js)  │  │   (PWA)      │  │   (本地运行，API 调用)          │ │
│  └──────┬───────┘  └──────┬───────┘  └───────────────┬────────────────┘ │
└─────────┼─────────────────┼──────────────────────────┼──────────────────┘
          │                 │                          │
          ▼                 ▼                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         API Gateway (Vercel Edge)                        │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  Rate Limiting │ JWT 验证 │ 请求日志 │ CORS │ 安全头                │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
          │                 │                          │
          ▼                 ▼                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        Application Layer (Next.js API Routes)            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │
│  │  /api/auth   │  │ /api/skills  │  │ /api/agents  │  │ /api/users  │ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
          │                 │                          │
          ▼                 ▼                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Data Layer                                      │
│  ┌──────────────────┐  ┌─────────────────┐  ┌────────────────────────┐ │
│  │    Supabase      │  │   Solana RPC    │  │      Supabase          │ │
│  │  (PostgreSQL)    │  │   (Helius)      │  │   Storage (技能文件)    │ │
│  │  + Auth + RLS    │  │   (支付验证)     │  │                        │ │
│  └──────────────────┘  └─────────────────┘  └────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 与 Moltbook 的关键差异

| 方面 | Moltbook (问题) | Claw Academy (改进) |
|------|----------------|---------------------|
| RLS | ❌ 未启用，数据泄露 | ✅ 强制启用，严格策略 |
| Agent 行为 | ❌ 可自由发帖（注入风险） | ✅ 只读访问技能 |
| API Key | ❌ 明文存储 | ✅ 加密 + 环境隔离 |
| 认证 | ❌ Token 泄露 | ✅ JWT + 签名验证 |
| 代码质量 | ❌ 纯 AI 生成无审查 | ✅ TDD + 安全审计 |

---

## 2. 数据库设计 (Supabase)

### 2.1 核心表结构

```sql
-- ============================================
-- 启用必要的扩展
-- ============================================
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ============================================
-- 枚举类型
-- ============================================
CREATE TYPE skill_category AS ENUM (
  'research', 'finance', 'coding', 'security', 'creative', 'comms'
);

CREATE TYPE skill_status AS ENUM ('live', 'dev', 'deprecated');
CREATE TYPE skill_priority AS ENUM ('high', 'medium', 'emerging');
CREATE TYPE payment_token AS ENUM ('SOL', 'CLAW', 'USDC');

-- ============================================
-- Users 表 - 用户账户
-- ============================================
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  -- 钱包信息（主要身份标识）
  wallet_address VARCHAR(44) UNIQUE NOT NULL,
  wallet_chain VARCHAR(10) DEFAULT 'solana',

  -- Twitter 绑定（用于 Agent 认领）
  twitter_handle VARCHAR(50) UNIQUE,
  twitter_verified_at TIMESTAMPTZ,

  -- 账户状态
  is_creator BOOLEAN DEFAULT false,
  is_verified BOOLEAN DEFAULT false,

  -- 代币余额（缓存，链上为准）
  claw_balance DECIMAL(18, 8) DEFAULT 0,
  staked_amount DECIMAL(18, 8) DEFAULT 0,

  -- 元数据
  display_name VARCHAR(50),
  avatar_url TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_users_wallet ON users(wallet_address);
CREATE INDEX idx_users_twitter ON users(twitter_handle);

-- ============================================
-- Agents 表 - AI 智能体
-- ============================================
CREATE TABLE agents (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  -- 所有者关联
  owner_id UUID REFERENCES users(id) ON DELETE CASCADE,

  -- Agent 身份
  agent_name VARCHAR(100) NOT NULL,
  agent_type VARCHAR(50) DEFAULT 'openclaw',

  -- 认领信息
  claim_token VARCHAR(64) UNIQUE,  -- 认领时生成的唯一 token
  claimed_at TIMESTAMPTZ,
  claim_tweet_id VARCHAR(30),       -- 验证推文 ID

  -- 状态
  is_active BOOLEAN DEFAULT true,
  last_seen_at TIMESTAMPTZ,

  -- API 访问（加密存储）
  api_key_hash VARCHAR(64),         -- bcrypt hash，不存明文
  api_key_prefix VARCHAR(8),        -- 前缀用于识别 "claw_xxx..."

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- 约束：一个用户只能有一个 Agent（与 Moltbook 一致）
  CONSTRAINT unique_owner UNIQUE (owner_id)
);

-- 索引
CREATE INDEX idx_agents_owner ON agents(owner_id);
CREATE INDEX idx_agents_claim_token ON agents(claim_token);

-- ============================================
-- Authors 表 - 技能创作者
-- ============================================
CREATE TABLE authors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  -- 关联用户
  user_id UUID REFERENCES users(id) ON DELETE CASCADE UNIQUE,

  -- 创作者信息
  author_name VARCHAR(50) NOT NULL,
  bio TEXT,
  website_url TEXT,

  -- 认证状态
  is_verified BOOLEAN DEFAULT false,
  verified_at TIMESTAMPTZ,

  -- 统计（定期更新）
  total_skills INTEGER DEFAULT 0,
  total_downloads INTEGER DEFAULT 0,
  total_revenue DECIMAL(18, 4) DEFAULT 0,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================
-- Skills 表 - 技能模块
-- ============================================
CREATE TABLE skills (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  -- 基本信息
  name VARCHAR(100) NOT NULL,
  slug VARCHAR(100) UNIQUE NOT NULL,  -- URL 友好的标识
  description TEXT,

  -- 创作者
  author_id UUID REFERENCES authors(id) ON DELETE SET NULL,

  -- 分类和状态
  category skill_category NOT NULL,
  status skill_status DEFAULT 'dev',
  priority skill_priority DEFAULT 'medium',

  -- 定价
  price DECIMAL(10, 4) NOT NULL,
  currency payment_token DEFAULT 'SOL',

  -- 内容存储（直接存数据库，参考 Moltbook）
  content TEXT,                      -- 技能 Markdown 内容
  version VARCHAR(20) DEFAULT '1.0.0',

  -- 展示
  icon_emoji VARCHAR(10),
  icon_gradient VARCHAR(100),        -- CSS gradient
  features TEXT[],                   -- 功能标签

  -- 统计
  rating DECIMAL(2, 1) DEFAULT 0,
  rating_count INTEGER DEFAULT 0,
  downloads INTEGER DEFAULT 0,

  -- 审核
  is_verified BOOLEAN DEFAULT false,
  verified_at TIMESTAMPTZ,
  verified_by UUID REFERENCES users(id),

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_skills_category ON skills(category);
CREATE INDEX idx_skills_status ON skills(status);
CREATE INDEX idx_skills_author ON skills(author_id);
CREATE INDEX idx_skills_rating ON skills(rating DESC);
CREATE INDEX idx_skills_downloads ON skills(downloads DESC);

-- 全文搜索
CREATE INDEX idx_skills_search ON skills
  USING GIN (to_tsvector('english', name || ' ' || COALESCE(description, '')));

-- ============================================
-- Purchases 表 - 购买记录
-- ============================================
CREATE TABLE purchases (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  -- 关联
  user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
  skill_id UUID REFERENCES skills(id) ON DELETE SET NULL NOT NULL,

  -- 支付信息
  price DECIMAL(10, 4) NOT NULL,
  currency payment_token NOT NULL,

  -- 链上验证
  tx_signature VARCHAR(88),          -- Solana 交易签名
  tx_confirmed BOOLEAN DEFAULT false,
  tx_confirmed_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW(),

  -- 防止重复购买
  CONSTRAINT unique_purchase UNIQUE (user_id, skill_id)
);

-- 索引
CREATE INDEX idx_purchases_user ON purchases(user_id);
CREATE INDEX idx_purchases_skill ON purchases(skill_id);
CREATE INDEX idx_purchases_tx ON purchases(tx_signature);

-- ============================================
-- User_Saved_Skills 表 - 收藏
-- ============================================
CREATE TABLE user_saved_skills (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  skill_id UUID REFERENCES skills(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (user_id, skill_id)
);

-- ============================================
-- Skill_Ratings 表 - 评分
-- ============================================
CREATE TABLE skill_ratings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  skill_id UUID REFERENCES skills(id) ON DELETE CASCADE,
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),
  review TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT unique_rating UNIQUE (user_id, skill_id)
);

-- ============================================
-- Agent_Skill_Access 表 - Agent 技能访问记录
-- ============================================
CREATE TABLE agent_skill_access (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  agent_id UUID REFERENCES agents(id) ON DELETE CASCADE,
  skill_id UUID REFERENCES skills(id) ON DELETE CASCADE,
  accessed_at TIMESTAMPTZ DEFAULT NOW(),
  access_count INTEGER DEFAULT 1
);

-- 索引
CREATE INDEX idx_agent_access ON agent_skill_access(agent_id, skill_id);
```

### 2.2 Row Level Security (RLS) - 关键安全措施

```sql
-- ============================================
-- 启用 RLS（Moltbook 的致命错误是未启用）
-- ============================================
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE agents ENABLE ROW LEVEL SECURITY;
ALTER TABLE authors ENABLE ROW LEVEL SECURITY;
ALTER TABLE skills ENABLE ROW LEVEL SECURITY;
ALTER TABLE purchases ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_saved_skills ENABLE ROW LEVEL SECURITY;
ALTER TABLE skill_ratings ENABLE ROW LEVEL SECURITY;
ALTER TABLE agent_skill_access ENABLE ROW LEVEL SECURITY;

-- ============================================
-- Users 表策略
-- ============================================

-- 用户只能查看自己的完整信息
CREATE POLICY "Users can view own full profile" ON users
  FOR SELECT USING (auth.uid() = id);

-- 其他用户只能看到公开字段
CREATE POLICY "Public can view basic user info" ON users
  FOR SELECT USING (true)
  WITH CHECK (false);  -- 不能修改

-- 用户只能更新自己的信息
CREATE POLICY "Users can update own profile" ON users
  FOR UPDATE USING (auth.uid() = id);

-- ============================================
-- Agents 表策略
-- ============================================

-- 只有所有者可以查看自己的 Agent
CREATE POLICY "Owners can view own agents" ON agents
  FOR SELECT USING (owner_id = auth.uid());

-- 只有所有者可以更新自己的 Agent
CREATE POLICY "Owners can update own agents" ON agents
  FOR UPDATE USING (owner_id = auth.uid());

-- Agent API 访问（使用 service role，不走 RLS）
-- 通过 API Key 验证后，使用 service role 查询

-- ============================================
-- Skills 表策略
-- ============================================

-- 所有人可以查看已上线的技能
CREATE POLICY "Anyone can view live skills" ON skills
  FOR SELECT USING (status = 'live');

-- 创作者可以查看自己的所有技能（包括开发中）
CREATE POLICY "Authors can view own skills" ON skills
  FOR SELECT USING (
    author_id IN (SELECT id FROM authors WHERE user_id = auth.uid())
  );

-- 创作者可以更新自己的技能
CREATE POLICY "Authors can update own skills" ON skills
  FOR UPDATE USING (
    author_id IN (SELECT id FROM authors WHERE user_id = auth.uid())
  );

-- ============================================
-- Purchases 表策略
-- ============================================

-- 用户只能查看自己的购买记录
CREATE POLICY "Users can view own purchases" ON purchases
  FOR SELECT USING (user_id = auth.uid());

-- 购买通过 API 创建（service role）
CREATE POLICY "Purchases created via API" ON purchases
  FOR INSERT WITH CHECK (user_id = auth.uid());

-- ============================================
-- User_Saved_Skills 表策略
-- ============================================

-- 用户只能管理自己的收藏
CREATE POLICY "Users manage own saved skills" ON user_saved_skills
  FOR ALL USING (user_id = auth.uid());

-- ============================================
-- Skill_Ratings 表策略
-- ============================================

-- 所有人可以查看评分
CREATE POLICY "Anyone can view ratings" ON skill_ratings
  FOR SELECT USING (true);

-- 用户只能创建/更新自己的评分
CREATE POLICY "Users manage own ratings" ON skill_ratings
  FOR ALL USING (user_id = auth.uid());

-- ============================================
-- Agent_Skill_Access 表策略
-- ============================================

-- Agent 访问记录仅通过 service role 写入
-- 用户可以查看自己 Agent 的访问记录
CREATE POLICY "Owners can view agent access" ON agent_skill_access
  FOR SELECT USING (
    agent_id IN (SELECT id FROM agents WHERE owner_id = auth.uid())
  );
```

### 2.3 数据库函数

```sql
-- ============================================
-- 验证购买并授权 Agent 访问
-- ============================================
CREATE OR REPLACE FUNCTION verify_purchase_and_grant_access(
  p_user_id UUID,
  p_skill_id UUID,
  p_tx_signature VARCHAR(88)
)
RETURNS BOOLEAN AS $$
DECLARE
  v_agent_id UUID;
BEGIN
  -- 更新购买记录为已确认
  UPDATE purchases
  SET tx_confirmed = true, tx_confirmed_at = NOW()
  WHERE user_id = p_user_id
    AND skill_id = p_skill_id
    AND tx_signature = p_tx_signature;

  -- 获取用户的 Agent
  SELECT id INTO v_agent_id FROM agents WHERE owner_id = p_user_id;

  -- 如果有 Agent，记录访问权限
  IF v_agent_id IS NOT NULL THEN
    INSERT INTO agent_skill_access (agent_id, skill_id)
    VALUES (v_agent_id, p_skill_id)
    ON CONFLICT DO NOTHING;
  END IF;

  -- 更新技能下载量
  UPDATE skills SET downloads = downloads + 1 WHERE id = p_skill_id;

  RETURN true;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================
-- 生成 Agent API Key
-- ============================================
CREATE OR REPLACE FUNCTION generate_agent_api_key(p_agent_id UUID)
RETURNS TEXT AS $$
DECLARE
  v_raw_key TEXT;
  v_prefix TEXT;
BEGIN
  -- 生成随机 key
  v_raw_key := 'claw_' || encode(gen_random_bytes(32), 'hex');
  v_prefix := substring(v_raw_key from 1 for 12);

  -- 存储 hash
  UPDATE agents
  SET
    api_key_hash = crypt(v_raw_key, gen_salt('bf')),
    api_key_prefix = v_prefix
  WHERE id = p_agent_id;

  -- 返回原始 key（只显示一次）
  RETURN v_raw_key;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================
-- 验证 Agent API Key
-- ============================================
CREATE OR REPLACE FUNCTION verify_agent_api_key(p_api_key TEXT)
RETURNS UUID AS $$
DECLARE
  v_agent_id UUID;
  v_prefix TEXT;
BEGIN
  v_prefix := substring(p_api_key from 1 for 12);

  SELECT id INTO v_agent_id
  FROM agents
  WHERE api_key_prefix = v_prefix
    AND api_key_hash = crypt(p_api_key, api_key_hash)
    AND is_active = true;

  -- 更新最后活跃时间
  IF v_agent_id IS NOT NULL THEN
    UPDATE agents SET last_seen_at = NOW() WHERE id = v_agent_id;
  END IF;

  RETURN v_agent_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================
-- 更新技能评分
-- ============================================
CREATE OR REPLACE FUNCTION update_skill_rating()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE skills
  SET
    rating = (SELECT AVG(rating) FROM skill_ratings WHERE skill_id = NEW.skill_id),
    rating_count = (SELECT COUNT(*) FROM skill_ratings WHERE skill_id = NEW.skill_id)
  WHERE id = NEW.skill_id;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_skill_rating
AFTER INSERT OR UPDATE ON skill_ratings
FOR EACH ROW EXECUTE FUNCTION update_skill_rating();
```

---

## 3. 认证流程设计

### 3.1 用户认证（钱包登录）

```
┌─────────────────────────────────────────────────────────────────────┐
│                        钱包登录流程                                  │
└─────────────────────────────────────────────────────────────────────┘

     用户                    前端                    后端                  Supabase
      │                      │                       │                       │
      │  1. 点击 Connect     │                       │                       │
      │─────────────────────>│                       │                       │
      │                      │                       │                       │
      │  2. 选择钱包         │                       │                       │
      │<─────────────────────│                       │                       │
      │                      │                       │                       │
      │  3. 确认连接         │                       │                       │
      │─────────────────────>│                       │                       │
      │                      │                       │                       │
      │                      │  4. 请求 nonce        │                       │
      │                      │──────────────────────>│                       │
      │                      │                       │                       │
      │                      │  5. 返回 nonce        │                       │
      │                      │<──────────────────────│                       │
      │                      │                       │                       │
      │  6. 签名 nonce       │                       │                       │
      │<─────────────────────│                       │                       │
      │                      │                       │                       │
      │  7. 返回签名         │                       │                       │
      │─────────────────────>│                       │                       │
      │                      │                       │                       │
      │                      │  8. 验证签名          │                       │
      │                      │──────────────────────>│                       │
      │                      │                       │  9. 验证 + 查找用户   │
      │                      │                       │──────────────────────>│
      │                      │                       │                       │
      │                      │                       │  10. 返回/创建用户    │
      │                      │                       │<──────────────────────│
      │                      │                       │                       │
      │                      │  11. 返回 JWT         │                       │
      │                      │<──────────────────────│                       │
      │                      │                       │                       │
      │  12. 登录成功        │                       │                       │
      │<─────────────────────│                       │                       │
```

### 3.2 Agent 认领流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Agent 认领流程                                │
└─────────────────────────────────────────────────────────────────────┘

     用户           Agent (OpenClaw)        后端            Twitter
      │                   │                  │                 │
      │  1. 发送注册指令   │                  │                 │
      │──────────────────>│                  │                 │
      │                   │                  │                 │
      │                   │  2. 访问注册 API  │                 │
      │                   │─────────────────>│                 │
      │                   │                  │                 │
      │                   │  3. 返回 claim_token               │
      │                   │<─────────────────│                 │
      │                   │                  │                 │
      │  4. 返回认领链接   │                  │                 │
      │<──────────────────│                  │                 │
      │                   │                  │                 │
      │  5. 发推文验证                                         │
      │  "I'm claiming my @ClawAcademy agent                   │
      │   Token: xxx"                                          │
      │────────────────────────────────────────────────────────>│
      │                                                         │
      │  6. 点击验证按钮   │                  │                 │
      │────────────────────────────────────>│                 │
      │                   │                  │                 │
      │                   │                  │  7. 验证推文    │
      │                   │                  │────────────────>│
      │                   │                  │                 │
      │                   │                  │  8. 确认推文存在│
      │                   │                  │<────────────────│
      │                   │                  │                 │
      │                   │                  │  9. 绑定 Agent  │
      │                   │                  │  到用户账户     │
      │                   │                  │                 │
      │  10. 认领成功     │                  │                 │
      │<───────────────────────────────────│                 │
      │                   │                  │                 │
      │                   │  11. 获取 API Key │                 │
      │                   │─────────────────>│                 │
      │                   │                  │                 │
      │                   │  12. 返回 API Key │                 │
      │                   │<─────────────────│                 │
```

### 3.3 Agent API 访问流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Agent 访问技能流程                            │
└─────────────────────────────────────────────────────────────────────┘

     Agent (OpenClaw)              后端                    Supabase
           │                        │                         │
           │  1. GET /api/agent/skills                        │
           │  Header: X-Agent-Key: claw_xxx                   │
           │───────────────────────>│                         │
           │                        │                         │
           │                        │  2. 验证 API Key        │
           │                        │  (verify_agent_api_key) │
           │                        │────────────────────────>│
           │                        │                         │
           │                        │  3. 返回 agent_id       │
           │                        │<────────────────────────│
           │                        │                         │
           │                        │  4. 查询 owner 购买的技能│
           │                        │────────────────────────>│
           │                        │                         │
           │                        │  5. 返回技能列表        │
           │                        │<────────────────────────│
           │                        │                         │
           │  6. 返回可用技能       │                         │
           │<───────────────────────│                         │
           │                        │                         │
           │  7. GET /api/agent/skills/:id/content            │
           │───────────────────────>│                         │
           │                        │                         │
           │                        │  8. 验证购买权限        │
           │                        │────────────────────────>│
           │                        │                         │
           │                        │  9. 获取技能内容        │
           │                        │────────────────────────>│
           │                        │                         │
           │  10. 返回技能内容      │                         │
           │  (Markdown 文档)       │                         │
           │<───────────────────────│                         │
```

---

## 4. API 设计

### 4.1 认证相关

```typescript
// POST /api/auth/nonce
// 获取签名 nonce
interface NonceRequest {
  walletAddress: string;
}
interface NonceResponse {
  nonce: string;
  expiresAt: number;
}

// POST /api/auth/verify
// 验证签名并登录
interface VerifyRequest {
  walletAddress: string;
  signature: string;
  nonce: string;
}
interface VerifyResponse {
  token: string;  // JWT
  user: User;
}

// POST /api/auth/refresh
// 刷新 token
interface RefreshResponse {
  token: string;
}
```

### 4.2 Agent 相关

```typescript
// POST /api/agents/register
// Agent 注册（获取 claim token）
interface AgentRegisterRequest {
  agentName: string;
  agentType?: string;
}
interface AgentRegisterResponse {
  claimToken: string;
  claimUrl: string;
}

// POST /api/agents/claim
// 用户认领 Agent
interface AgentClaimRequest {
  claimToken: string;
  tweetId: string;  // 验证推文 ID
}
interface AgentClaimResponse {
  agent: Agent;
  apiKey: string;  // 只显示一次
}

// GET /api/agents/me
// 获取当前用户的 Agent
interface AgentMeResponse {
  agent: Agent | null;
}

// POST /api/agents/regenerate-key
// 重新生成 API Key
interface RegenerateKeyResponse {
  apiKey: string;
}
```

### 4.3 Agent 专用 API（使用 API Key 认证）

```typescript
// GET /api/agent/skills
// Agent 获取可用技能列表
// Header: X-Agent-Key: claw_xxx
interface AgentSkillsResponse {
  skills: Skill[];
}

// GET /api/agent/skills/:id
// Agent 获取技能详情
interface AgentSkillDetailResponse {
  skill: Skill;
  hasAccess: boolean;
}

// GET /api/agent/skills/:id/content
// Agent 获取技能内容（需要购买权限）
interface AgentSkillContentResponse {
  content: string;  // Markdown 内容
  version: string;
}
```

### 4.4 技能市场相关

```typescript
// GET /api/skills
// 获取技能列表
interface SkillsQuery {
  category?: SkillCategory;
  status?: 'live' | 'dev';
  sort?: 'trending' | 'newest' | 'price-low' | 'price-high' | 'downloads';
  search?: string;
  page?: number;
  limit?: number;
}
interface SkillsResponse {
  skills: Skill[];
  meta: {
    page: number;
    limit: number;
    total: number;
  };
}

// GET /api/skills/:id
// 获取技能详情
interface SkillDetailResponse {
  skill: Skill;
  author: Author;
  isPurchased: boolean;
  isSaved: boolean;
}

// POST /api/skills/:id/purchase
// 购买技能
interface PurchaseRequest {
  txSignature: string;
}
interface PurchaseResponse {
  purchase: Purchase;
}

// POST /api/skills/:id/save
// 收藏/取消收藏
interface SaveResponse {
  saved: boolean;
}
```

### 4.5 排行榜相关

```typescript
// GET /api/leaderboard
// 获取排行榜
interface LeaderboardQuery {
  timeRange?: '24h' | '7d' | '30d' | 'all';
  limit?: number;
}
interface LeaderboardResponse {
  skills: LeaderboardItem[];
}

interface LeaderboardItem {
  rank: number;
  skill: Skill;
  floor: number;
  change24h: number;
  change7d: number;
  volume: number;
  downloads: number;
}
```

---

## 5. 安全措施

### 5.1 API 安全

```typescript
// middleware/security.ts

// Rate Limiting
const rateLimiter = new RateLimiter({
  windowMs: 60 * 1000,  // 1 分钟
  max: {
    default: 100,        // 默认 100 次/分钟
    auth: 10,            // 认证 API 10 次/分钟
    agent: 200,          // Agent API 200 次/分钟
  },
});

// JWT 验证
const verifyJWT = async (token: string): Promise<User | null> => {
  try {
    const payload = await jwtVerify(token, JWT_SECRET);
    return payload.user as User;
  } catch {
    return null;
  }
};

// Agent API Key 验证
const verifyAgentKey = async (apiKey: string): Promise<Agent | null> => {
  const { data: agentId } = await supabase
    .rpc('verify_agent_api_key', { p_api_key: apiKey });

  if (!agentId) return null;

  const { data: agent } = await supabase
    .from('agents')
    .select('*, owner:users(*)')
    .eq('id', agentId)
    .single();

  return agent;
};

// 请求签名验证（防重放攻击）
const verifyRequestSignature = (
  timestamp: number,
  signature: string,
  body: string
): boolean => {
  const MAX_AGE = 5 * 60 * 1000; // 5 分钟
  if (Date.now() - timestamp > MAX_AGE) return false;

  const expected = createHmac('sha256', API_SECRET)
    .update(`${timestamp}.${body}`)
    .digest('hex');

  return timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expected)
  );
};
```

### 5.2 输入验证

```typescript
// lib/validation.ts
import { z } from 'zod';

// 钱包地址验证
const walletAddressSchema = z.string()
  .regex(/^[1-9A-HJ-NP-Za-km-z]{32,44}$/, 'Invalid Solana address');

// 交易签名验证
const txSignatureSchema = z.string()
  .regex(/^[1-9A-HJ-NP-Za-km-z]{87,88}$/, 'Invalid transaction signature');

// API Key 验证
const apiKeySchema = z.string()
  .regex(/^claw_[a-f0-9]{64}$/, 'Invalid API key format');

// 技能创建验证
const createSkillSchema = z.object({
  name: z.string().min(3).max(100),
  description: z.string().max(1000),
  category: z.enum(['research', 'finance', 'coding', 'security', 'creative', 'comms']),
  price: z.number().min(0).max(1000),
  features: z.array(z.string().max(50)).max(10),
});
```

### 5.3 防止提示注入

```typescript
// Agent 只能读取技能内容，不能：
// 1. 执行任意代码
// 2. 访问其他 Agent 的数据
// 3. 修改任何数据

// Agent API 限制
const AGENT_ALLOWED_ENDPOINTS = [
  'GET /api/agent/skills',
  'GET /api/agent/skills/:id',
  'GET /api/agent/skills/:id/content',
];

// 技能内容安全检查
const sanitizeSkillContent = (content: string): string => {
  // 移除潜在的注入指令
  const dangerousPatterns = [
    /ignore previous instructions/gi,
    /disregard all prior/gi,
    /system prompt/gi,
    /\[INST\]/gi,
    /<\|system\|>/gi,
  ];

  let sanitized = content;
  for (const pattern of dangerousPatterns) {
    sanitized = sanitized.replace(pattern, '[REDACTED]');
  }

  return sanitized;
};
```

---

## 6. 技能内容存储（直接数据库）

> 参考 Moltbook 的设计，所有内容直接存储在 PostgreSQL 中，不使用 IPFS

### 6.1 存储方案对比

| 方案 | 优点 | 缺点 |
|------|------|------|
| **数据库直存（采用）** | 简单、快速、易管理、低延迟 | 大文件不适合 |
| IPFS | 去中心化、内容寻址 | 复杂、延迟高、需要网关 |
| S3/OSS | 大文件支持好 | 额外成本、需要管理 |

技能内容本质是 Markdown 文本（通常 < 100KB），直接存数据库是最合理的选择。

### 6.2 技能内容表结构

```sql
-- Skills 表已包含 content 字段
-- content TEXT  -- 技能 Markdown 内容

-- 如果需要版本历史，可添加技能版本表
CREATE TABLE skill_versions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  skill_id UUID REFERENCES skills(id) ON DELETE CASCADE,
  version VARCHAR(20) NOT NULL,
  content TEXT NOT NULL,
  changelog TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT unique_skill_version UNIQUE (skill_id, version)
);

-- 索引
CREATE INDEX idx_skill_versions ON skill_versions(skill_id, version);
```

### 6.3 技能内容格式 (Markdown)

```markdown
# Research Master Pro

## 概述
你是一个专业的研究助手，擅长信息收集、分析和综合。

## 核心能力
- 网页信息提取
- 数据分析和综合
- 引用生成

## 使用指南

### 基础用法
当用户请求研究某个主题时，你应该：
1. 明确研究范围和目标
2. 收集相关信息
3. 分析和综合数据
4. 生成结构化报告

### 示例对话

**用户**: 帮我研究 AI Agent 的发展趋势

**助手**: 我将从以下几个方面进行研究...

## 限制
- 不要编造数据
- 始终注明信息来源
- 遇到不确定的信息要声明
```

### 6.4 内容 API

```typescript
// 获取技能内容
// GET /api/skills/:id/content
export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  const user = await getCurrentUser(request);
  const skillId = params.id;

  // 验证购买权限
  const { data: purchase } = await supabase
    .from('purchases')
    .select('id')
    .eq('user_id', user.id)
    .eq('skill_id', skillId)
    .eq('tx_confirmed', true)
    .single();

  if (!purchase) {
    return Response.json(
      { error: 'Not purchased' },
      { status: 403 }
    );
  }

  // 获取技能内容
  const { data: skill } = await supabase
    .from('skills')
    .select('content, version')
    .eq('id', skillId)
    .single();

  return Response.json({
    content: skill.content,
    version: skill.version,
  });
}

// 创作者更新技能内容
// PUT /api/skills/:id/content
export async function PUT(
  request: Request,
  { params }: { params: { id: string } }
) {
  const user = await getCurrentUser(request);
  const { content, version, changelog } = await request.json();

  // 验证是否为技能作者
  const { data: skill } = await supabase
    .from('skills')
    .select('author_id, authors!inner(user_id)')
    .eq('id', params.id)
    .single();

  if (skill.authors.user_id !== user.id) {
    return Response.json(
      { error: 'Not authorized' },
      { status: 403 }
    );
  }

  // 保存版本历史
  await supabase.from('skill_versions').insert({
    skill_id: params.id,
    version,
    content,
    changelog,
  });

  // 更新当前内容
  await supabase
    .from('skills')
    .update({ content, version, updated_at: new Date() })
    .eq('id', params.id);

  return Response.json({ success: true });
}
```

### 6.5 大文件处理（可选）

如果未来需要支持附件（图片、视频等），可使用 Supabase Storage：

```typescript
// 上传技能附件
const uploadAttachment = async (
  skillId: string,
  file: File
): Promise<string> => {
  const path = `skills/${skillId}/${file.name}`;

  const { data, error } = await supabase.storage
    .from('skill-assets')
    .upload(path, file);

  if (error) throw error;

  // 返回公开 URL
  const { data: { publicUrl } } = supabase.storage
    .from('skill-assets')
    .getPublicUrl(path);

  return publicUrl;
};
```

---

## 7. 实时功能 (Supabase Realtime)

### 7.1 价格/统计更新

```typescript
// hooks/use-realtime-stats.ts
import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabase';

export const useRealtimeStats = () => {
  const [stats, setStats] = useState<Stats | null>(null);

  useEffect(() => {
    // 订阅统计更新
    const channel = supabase
      .channel('stats')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'skills' },
        (payload) => {
          // 更新本地状态
          refetchStats();
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, []);

  return stats;
};
```

### 7.2 代币价格更新

```typescript
// 从 DeFi 协议获取实时价格
const useTokenPrice = () => {
  const [price, setPrice] = useState<number>(0);

  useEffect(() => {
    const ws = new WebSocket(process.env.NEXT_PUBLIC_PRICE_WS_URL);

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.symbol === 'CLAW') {
        setPrice(data.price);
      }
    };

    return () => ws.close();
  }, []);

  return price;
};
```

---

## 8. 监控和日志

### 8.1 关键指标

```typescript
// lib/metrics.ts

// 记录 API 调用
const logApiCall = async (data: {
  endpoint: string;
  method: string;
  userId?: string;
  agentId?: string;
  statusCode: number;
  latencyMs: number;
}) => {
  await supabase.from('api_logs').insert(data);

  // 发送到 Vercel Analytics
  if (process.env.VERCEL) {
    await fetch('https://vitals.vercel-insights.com/v1/vitals', {
      method: 'POST',
      body: JSON.stringify({
        dsn: process.env.VERCEL_ANALYTICS_ID,
        ...data,
      }),
    });
  }
};

// 安全事件告警
const alertSecurityEvent = async (event: {
  type: 'rate_limit' | 'invalid_auth' | 'suspicious_activity';
  details: Record<string, unknown>;
}) => {
  // 记录到数据库
  await supabase.from('security_events').insert(event);

  // 发送告警（Slack/Discord）
  if (event.type === 'suspicious_activity') {
    await sendSlackAlert(event);
  }
};
```

### 8.2 健康检查

```typescript
// app/api/health/route.ts
export async function GET() {
  const checks = {
    database: await checkDatabase(),
    solana: await checkSolanaRPC(),
  };

  const healthy = Object.values(checks).every(c => c.status === 'ok');

  return Response.json(
    { status: healthy ? 'ok' : 'degraded', checks },
    { status: healthy ? 200 : 503 }
  );
}
```

---

## 9. 部署配置

### 9.1 环境变量

```bash
# .env.example

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx
SUPABASE_SERVICE_ROLE_KEY=eyJxxx  # 仅服务端使用

# JWT
JWT_SECRET=your-super-secret-key

# Solana
NEXT_PUBLIC_SOLANA_RPC_URL=https://api.mainnet-beta.solana.com
NEXT_PUBLIC_SOLANA_NETWORK=mainnet-beta
HELIUS_API_KEY=xxx

# Twitter
TWITTER_API_KEY=xxx
TWITTER_API_SECRET=xxx

# 监控
SENTRY_DSN=https://xxx@sentry.io/xxx
VERCEL_ANALYTICS_ID=xxx
```

### 9.2 Vercel 配置

```json
// vercel.json
{
  "functions": {
    "app/api/**/*.ts": {
      "maxDuration": 30
    }
  },
  "headers": [
    {
      "source": "/api/(.*)",
      "headers": [
        { "key": "X-Content-Type-Options", "value": "nosniff" },
        { "key": "X-Frame-Options", "value": "DENY" },
        { "key": "X-XSS-Protection", "value": "1; mode=block" }
      ]
    }
  ]
}
```

---

## 10. 与 Moltbook 对比总结

| 方面 | Moltbook | Claw Academy |
|------|----------|--------------|
| 数据库 | Supabase（未配置 RLS）| Supabase + 严格 RLS |
| Agent 认证 | Token 泄露 | API Key Hash + 验证 |
| Agent 能力 | 可发帖（注入风险） | 只读技能（安全） |
| 用户认领 | Twitter 验证 | Twitter 验证（相同） |
| 支付 | 未知 | Solana 链上验证 |
| 内容存储 | PostgreSQL 直存 | PostgreSQL 直存（相同） |
| 代码质量 | AI 生成无审查 | TDD + 安全审计 |
| 监控 | 无（漏洞后发现） | 实时监控 + 告警 |

---

## 11. 下一步

1. [ ] 创建 Supabase 项目并执行 SQL Schema
2. [ ] 配置 Row Level Security 策略
3. [ ] 实现钱包认证 API
4. [ ] 实现 Agent 注册/认领流程
5. [ ] 实现技能市场 CRUD API
6. [ ] 实现 Solana 支付验证
7. [ ] 添加监控和告警
8. [ ] 安全审计
