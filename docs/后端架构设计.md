# 后端架构设计

> Agent API Key 认证 + 自动支付架构

## 1. 架构概览

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            Client Layer                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────────────────────────┐ │
│  │   Browser    │  │   Mobile     │  │      OpenClaw Agent            │ │
│  │   (Next.js)  │  │   (PWA)      │  │   (agent-sdk)                  │ │
│  └──────┬───────┘  └──────┬───────┘  └───────────────┬────────────────┘ │
└─────────┼─────────────────┼──────────────────────────┼──────────────────┘
          │                 │                          │
          ▼                 ▼                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         API Gateway (Vercel Edge)                        │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  Rate Limiting │ API Key 验证 │ 请求日志 │ CORS │ 安全头           │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
          │                 │                          │
          ▼                 ▼                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        Application Layer (Next.js API Routes)            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │
│  │ /api/agents  │  │ /api/skills  │  │/api/purchases│  │/api/leader- │ │
│  │              │  │              │  │              │  │   board     │ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
          │                 │                          │
          ▼                 ▼                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Data Layer                                      │
│  ┌──────────────────┐  ┌─────────────────┐  ┌────────────────────────┐ │
│  │    Supabase      │  │   Solana RPC    │  │      Supabase          │ │
│  │  (PostgreSQL)    │  │   (Helius)      │  │   Storage (技能文件)    │ │
│  │  + RLS           │  │   (自动支付)     │  │                        │ │
│  └──────────────────┘  └─────────────────┘  └────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 核心设计决策

| 方面 | 决策 |
|------|------|
| 认证 | Agent API Key（无需用户钱包登录）|
| 支付 | Agent 绑定钱包，服务端自动签名 |
| 架构 | Next.js 全栈 (Serverless) |
| 部署 | Vercel + Supabase |

---

## 2. 数据库设计 (Supabase)

### 2.1 核心表结构

```sql
-- ============================================
-- 启用必要的扩展
-- ============================================
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ============================================
-- 枚举类型
-- ============================================
CREATE TYPE skill_category AS ENUM (
  'research', 'finance', 'coding', 'security', 'creative', 'comms'
);
CREATE TYPE skill_status AS ENUM ('live', 'dev', 'deprecated');
CREATE TYPE payment_token AS ENUM ('SOL', 'CLAW', 'USDC');
CREATE TYPE purchase_status AS ENUM ('confirmed', 'refunded');

-- ============================================
-- Users 表 - 用户账户（Agent 所有者）
-- ============================================
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  twitter_handle VARCHAR(50) UNIQUE,
  twitter_verified_at TIMESTAMPTZ,
  display_name VARCHAR(50),
  avatar_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================
-- Agents 表 - AI 智能体
-- ============================================
CREATE TABLE agents (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  owner_id UUID REFERENCES users(id) ON DELETE CASCADE,

  -- Agent 身份
  agent_name VARCHAR(100) NOT NULL,
  agent_type VARCHAR(50) DEFAULT 'openclaw',

  -- 钱包信息（自动支付）
  wallet_public_key VARCHAR(44) NOT NULL,
  wallet_encrypted_key TEXT NOT NULL,  -- AES-256-GCM 加密

  -- 认领信息
  claim_token VARCHAR(64) UNIQUE,
  claimed_at TIMESTAMPTZ,
  claim_tweet_id VARCHAR(30),

  -- API 访问
  api_key_hash VARCHAR(64),
  api_key_prefix VARCHAR(12),

  -- 状态
  is_active BOOLEAN DEFAULT true,
  last_seen_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT unique_owner UNIQUE (owner_id)
);

CREATE INDEX idx_agents_owner ON agents(owner_id);
CREATE INDEX idx_agents_api_key_prefix ON agents(api_key_prefix);
CREATE INDEX idx_agents_claim_token ON agents(claim_token);

-- ============================================
-- Authors 表 - 技能创作者
-- ============================================
CREATE TABLE authors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE UNIQUE,
  author_name VARCHAR(50) NOT NULL,
  bio TEXT,
  is_verified BOOLEAN DEFAULT false,
  total_skills INTEGER DEFAULT 0,
  total_downloads INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================
-- Skills 表 - 技能模块
-- ============================================
CREATE TABLE skills (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(100) NOT NULL,
  slug VARCHAR(100) UNIQUE NOT NULL,
  description TEXT,
  author_id UUID REFERENCES authors(id) ON DELETE SET NULL,
  category skill_category NOT NULL,
  status skill_status DEFAULT 'dev',
  price DECIMAL(10, 4) NOT NULL,
  currency payment_token DEFAULT 'SOL',
  content TEXT,
  version VARCHAR(20) DEFAULT '1.0.0',
  icon_emoji VARCHAR(10),
  features TEXT[],
  rating DECIMAL(2, 1) DEFAULT 0,
  downloads INTEGER DEFAULT 0,
  is_verified BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_skills_category ON skills(category);
CREATE INDEX idx_skills_status ON skills(status);
CREATE INDEX idx_skills_author ON skills(author_id);

-- ============================================
-- Purchases 表 - 购买记录
-- ============================================
CREATE TABLE purchases (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  agent_id UUID REFERENCES agents(id) ON DELETE CASCADE NOT NULL,
  skill_id UUID REFERENCES skills(id) ON DELETE SET NULL NOT NULL,
  price DECIMAL(10, 4) NOT NULL,
  currency payment_token NOT NULL,
  tx_signature VARCHAR(88),
  status purchase_status DEFAULT 'confirmed',
  created_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT unique_agent_purchase UNIQUE (agent_id, skill_id)
);

CREATE INDEX idx_purchases_agent ON purchases(agent_id);
CREATE INDEX idx_purchases_skill ON purchases(skill_id);
```

### 2.2 Row Level Security (RLS)

```sql
-- 启用 RLS
ALTER TABLE agents ENABLE ROW LEVEL SECURITY;
ALTER TABLE skills ENABLE ROW LEVEL SECURITY;
ALTER TABLE purchases ENABLE ROW LEVEL SECURITY;

-- Skills: 所有人可查看已上线技能
CREATE POLICY "Anyone can view live skills" ON skills
  FOR SELECT USING (status = 'live');

-- Purchases: 通过 service role 创建（API Key 验证后）
-- Agent 只能查看自己的购买记录
CREATE POLICY "Agents can view own purchases" ON purchases
  FOR SELECT USING (agent_id IN (
    SELECT id FROM agents WHERE api_key_prefix = current_setting('app.api_key_prefix', true)
  ));
```

### 2.3 数据库函数

```sql
-- ============================================
-- 验证 Agent API Key
-- ============================================
CREATE OR REPLACE FUNCTION verify_agent_api_key(p_api_key TEXT)
RETURNS UUID AS $$
DECLARE
  v_agent_id UUID;
  v_prefix TEXT;
BEGIN
  v_prefix := substring(p_api_key from 1 for 12);

  SELECT id INTO v_agent_id
  FROM agents
  WHERE api_key_prefix = v_prefix
    AND api_key_hash = crypt(p_api_key, api_key_hash)
    AND is_active = true;

  IF v_agent_id IS NOT NULL THEN
    UPDATE agents SET last_seen_at = NOW() WHERE id = v_agent_id;
  END IF;

  RETURN v_agent_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================
-- 生成 Agent API Key
-- ============================================
CREATE OR REPLACE FUNCTION generate_agent_api_key(p_agent_id UUID)
RETURNS TEXT AS $$
DECLARE
  v_raw_key TEXT;
  v_prefix TEXT;
BEGIN
  v_raw_key := 'awa_' || encode(gen_random_bytes(32), 'hex');
  v_prefix := substring(v_raw_key from 1 for 12);

  UPDATE agents
  SET
    api_key_hash = crypt(v_raw_key, gen_salt('bf')),
    api_key_prefix = v_prefix
  WHERE id = p_agent_id;

  RETURN v_raw_key;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## 3. 认证流程

### 3.1 Agent 注册与认领流程

```
     用户           Agent (OpenClaw)        后端            Twitter
      │                   │                  │                 │
      │  1. 发送注册指令   │                  │                 │
      │──────────────────>│                  │                 │
      │                   │                  │                 │
      │                   │  2. POST /api/agents/register      │
      │                   │  (包含钱包信息)   │                 │
      │                   │─────────────────>│                 │
      │                   │                  │                 │
      │                   │  3. 返回 claim_token               │
      │                   │<─────────────────│                 │
      │                   │                  │                 │
      │  4. 返回认领链接   │                  │                 │
      │<──────────────────│                  │                 │
      │                   │                  │                 │
      │  5. 发推文验证     │                  │                 │
      │────────────────────────────────────────────────────────>│
      │                   │                  │                 │
      │  6. 点击验证       │                  │                 │
      │───────────────────────────────────>│                 │
      │                   │                  │                 │
      │                   │                  │  7. 验证推文    │
      │                   │                  │────────────────>│
      │                   │                  │                 │
      │  8. 返回 API Key   │                  │                 │
      │<───────────────────────────────────│                 │
      │                   │                  │                 │
      │                   │  9. 使用 API Key 调用              │
      │                   │─────────────────>│                 │
```

### 3.2 Agent API 访问流程

```
     Agent (OpenClaw)              后端                    Supabase
           │                        │                         │
           │  1. GET /api/agent/skills                        │
           │  Header: X-Agent-Key: awa_xxx                    │
           │───────────────────────>│                         │
           │                        │                         │
           │                        │  2. 验证 API Key        │
           │                        │────────────────────────>│
           │                        │                         │
           │                        │  3. 返回 agent_id       │
           │                        │<────────────────────────│
           │                        │                         │
           │                        │  4. 查询已购买的技能    │
           │                        │────────────────────────>│
           │                        │                         │
           │  5. 返回技能列表       │                         │
           │<───────────────────────│                         │
```

---

## 4. 自动支付流程

### 4.1 支付架构

```
     Agent                    后端                   Solana
       │                       │                       │
       │  1. POST /api/purchases                       │
       │  { skillId }          │                       │
       │──────────────────────>│                       │
       │                       │                       │
       │                       │  2. 验证 Agent        │
       │                       │  3. 检查是否已购买    │
       │                       │  4. 获取技能价格      │
       │                       │                       │
       │                       │  5. 解密钱包私钥      │
       │                       │                       │
       │                       │  6. 构建交易          │
       │                       │  (from: agent wallet) │
       │                       │  (to: treasury)       │
       │                       │                       │
       │                       │  7. 签名并提交        │
       │                       │──────────────────────>│
       │                       │                       │
       │                       │  8. 确认              │
       │                       │<──────────────────────│
       │                       │                       │
       │                       │  9. 记录购买          │
       │                       │                       │
       │  10. 返回技能内容     │                       │
       │<──────────────────────│                       │
```

### 4.2 支付代码示例

```typescript
// app/api/purchases/route.ts
import { agentAuthMiddleware } from '@awa/auth/next';
import { payment } from '@/lib/payment';
import { skills } from '@/lib/skills';

export const POST = agentAuthMiddleware(async (req, { agent }) => {
  const { skillId } = await req.json();

  // 1. 检查是否已购买
  if (await payment.hasPurchased(agent.id, skillId)) {
    return Response.json({ error: 'Already purchased' }, { status: 400 });
  }

  // 2. 获取技能
  const skill = await skills.getById(skillId);
  if (!skill) {
    return Response.json({ error: 'Skill not found' }, { status: 404 });
  }

  // 3. 自动支付
  const result = await payment.purchaseSkill(agent.id, skillId);

  if (!result.success) {
    return Response.json({ error: result.error }, { status: 400 });
  }

  return Response.json({
    transactionSignature: result.transactionSignature,
    skillContent: result.skillContent,
  });
});
```

---

## 5. API 设计

### 5.1 Agent 相关

```typescript
// POST /api/agents/register
interface AgentRegisterRequest {
  agentName: string;
  agentType?: string;
  walletPublicKey: string;
  walletEncryptedKey: string;
}
interface AgentRegisterResponse {
  claimToken: string;
  claimUrl: string;
  walletAddress: string;
}

// POST /api/agents/claim
interface AgentClaimRequest {
  claimToken: string;
  tweetId: string;
}
interface AgentClaimResponse {
  agent: Agent;
  apiKey: string;  // 只显示一次
}

// GET /api/agents/:id/balance
interface AgentBalanceResponse {
  balance: number;
  currency: 'SOL';
}
```

### 5.2 Skills API (Agent 专用)

```typescript
// GET /api/agent/skills
// Header: X-Agent-Key: awa_xxx
interface AgentSkillsResponse {
  skills: AgentSkill[];
}

// GET /api/agent/skills/:id/content
interface AgentSkillContentResponse {
  content: string;
  version: string;
}

// POST /api/purchases
interface PurchaseRequest {
  skillId: string;
}
interface PurchaseResponse {
  transactionSignature: string;
  skillContent: string;
}
```

---

## 6. 安全措施

### 6.1 API Key 安全

```typescript
// API Key 永不明文存储
const hash = await bcrypt.hash(apiKey, 12);

// 验证时比较 hash
const isValid = await bcrypt.compare(apiKey, storedHash);
```

### 6.2 钱包私钥安全

```typescript
import { createCipheriv, createDecipheriv, randomBytes } from 'crypto';

// 加密存储
const encrypt = (privateKey: string, encryptionKey: string): string => {
  const iv = randomBytes(16);
  const cipher = createCipheriv('aes-256-gcm', encryptionKey, iv);
  // ...
};

// 解密使用（仅服务端）
const decrypt = (encryptedKey: string, encryptionKey: string): Uint8Array => {
  const decipher = createDecipheriv('aes-256-gcm', encryptionKey, iv);
  // ...
};
```

### 6.3 Rate Limiting

```typescript
const rateLimiter = new RateLimiter({
  windowMs: 60 * 1000,
  max: {
    default: 100,
    agent: 200,
  },
});
```

---

## 7. 环境变量

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx

# Solana
SOLANA_RPC_URL=https://mainnet.helius-rpc.com/?api-key=xxx
TREASURY_WALLET=xxx

# 加密
WALLET_ENCRYPTION_KEY=xxx  # 32 字节

# App
NEXT_PUBLIC_APP_URL=https://awa.academy
JWT_SECRET=xxx
```

---

## 8. 下一步

1. [ ] 创建 Supabase 项目并执行 SQL Schema
2. [ ] 配置 Row Level Security 策略
3. [ ] 实现 Agent API Key 认证
4. [ ] 实现 Agent 自动支付
5. [ ] 实现技能市场 API
6. [ ] 添加监控和告警
