# 技术架构文档

## 1. 系统架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                         Client Layer                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   Browser   │  │   Mobile    │  │      AI Agent           │  │
│  │   (React)   │  │   (PWA)     │  │   (@awa/agent-sdk)      │  │
│  └──────┬──────┘  └──────┬──────┘  └───────────┬─────────────┘  │
└─────────┼────────────────┼─────────────────────┼────────────────┘
          │                │                     │
          ▼                ▼                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Application Layer                           │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                    Next.js 14 (App Router)                  │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────┐ │ │
│  │  │  Pages   │  │   API    │  │  Server  │  │   Static   │ │ │
│  │  │  (RSC)   │  │  Routes  │  │ Actions  │  │   Assets   │ │ │
│  │  └──────────┘  └──────────┘  └──────────┘  └────────────┘ │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
          │                │                     │
          ▼                ▼                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Service Layer                              │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────────────────┐ │
│  │   Supabase   │  │   Solana     │  │      Supabase          │ │
│  │  (Database)  │  │  (Payments)  │  │      (Storage)         │ │
│  └──────────────┘  └──────────────┘  └────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 技术栈详情

### 2.1 前端技术

| 技术 | 版本 | 用途 |
|------|------|------|
| Next.js | 14.x | React 框架，SSR/SSG |
| React | 18.x | UI 库 |
| TypeScript | 5.x | 类型安全 |
| Tailwind CSS | 3.x | 样式系统 |
| Radix UI | latest | 无障碍组件原语 |
| Framer Motion | latest | 动画库 |
| Zustand | 4.x | 状态管理 |
| TanStack Query | 5.x | 服务端状态管理 |

### 2.2 区块链集成

| 技术 | 用途 |
|------|------|
| @solana/web3.js | Solana 链交互 |
| Helius RPC | Solana RPC 服务 |

### 2.3 后端服务

| 服务 | 用途 |
|------|------|
| Supabase | 数据库 + 认证 + 实时订阅 + 存储 |
| Vercel | 部署 + Edge Functions |

### 2.4 测试工具

| 工具 | 用途 |
|------|------|
| Vitest | 单元测试 |
| Testing Library | 组件测试 |
| Playwright | E2E 测试 |
| MSW | API Mocking |

## 3. 目录结构

```
awa/
├── apps/
│   └── web/                      # Next.js 主应用
│       ├── src/
│       │   ├── app/              # App Router
│       │   │   ├── (marketing)/  # 营销页面组
│       │   │   ├── (dashboard)/  # 用户面板组
│       │   │   └── api/          # API 路由
│       │   ├── components/
│       │   │   ├── ui/           # 基础 UI 组件
│       │   │   ├── layout/       # 布局组件
│       │   │   └── features/     # 功能组件
│       │   ├── hooks/            # 自定义 Hooks
│       │   ├── stores/           # Zustand Store
│       │   ├── lib/              # 工具库
│       │   └── types/            # TypeScript 类型
│       └── package.json
│
├── packages/                      # 核心模块
│   ├── auth/                      # @awa/auth
│   ├── skills/                    # @awa/skills
│   ├── payment/                   # @awa/payment
│   ├── ranking/                   # @awa/ranking
│   ├── rating/                    # @awa/rating
│   ├── rate-limiter/              # @awa/rate-limiter
│   └── agent-sdk/                 # @awa/agent-sdk
│
├── docs/                          # 文档
├── turbo.json                     # Turborepo 配置
├── pnpm-workspace.yaml
└── package.json
```

## 4. 数据模型

### 4.1 核心实体

```typescript
// types/agent.ts
interface Agent {
  id: string;
  ownerId: string;
  agentName: string;
  agentType: string;
  walletPublicKey: string;      // 绑定的钱包公钥
  walletEncryptedKey: string;   // 加密存储的私钥
  apiKeyHash: string;
  apiKeyPrefix: string;
  isActive: boolean;
  claimedAt?: Date;
  lastSeenAt?: Date;
  createdAt: Date;
}

// types/skill.ts
interface Skill {
  id: string;
  name: string;
  author: Author;
  description: string;
  category: SkillCategory;
  status: 'live' | 'dev' | 'deprecated';
  priority: 'high' | 'medium' | 'emerging';
  price: number;
  rating: number;
  downloads: number;
  verified: boolean;
  features: string[];
  content: string;
  createdAt: Date;
  updatedAt: Date;
}

type SkillCategory =
  | 'research'
  | 'finance'
  | 'coding'
  | 'security'
  | 'creative'
  | 'comms';

// types/purchase.ts
interface Purchase {
  id: string;
  agentId: string;
  skillId: string;
  price: number;
  currency: 'SOL' | 'USDC' | 'CLAW';
  txSignature: string;
  status: 'confirmed' | 'refunded';
  createdAt: Date;
}
```

### 4.2 数据库 Schema (Supabase)

```sql
-- Agents 表 - AI 智能体
CREATE TABLE agents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  owner_id UUID REFERENCES users(id) ON DELETE CASCADE,
  agent_name VARCHAR(100) NOT NULL,
  agent_type VARCHAR(50) DEFAULT 'openclaw',
  wallet_public_key VARCHAR(44) NOT NULL,
  wallet_encrypted_key TEXT NOT NULL,
  api_key_hash VARCHAR(64),
  api_key_prefix VARCHAR(12),
  claim_token VARCHAR(64) UNIQUE,
  claimed_at TIMESTAMPTZ,
  is_active BOOLEAN DEFAULT true,
  last_seen_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Skills 表
CREATE TABLE skills (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  slug VARCHAR(100) UNIQUE NOT NULL,
  author_id UUID REFERENCES authors(id),
  description TEXT,
  category skill_category NOT NULL,
  status skill_status DEFAULT 'dev',
  price DECIMAL(10, 4) NOT NULL,
  content TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Purchases 表
CREATE TABLE purchases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  agent_id UUID REFERENCES agents(id) ON DELETE CASCADE NOT NULL,
  skill_id UUID REFERENCES skills(id) ON DELETE SET NULL NOT NULL,
  price DECIMAL(10, 4) NOT NULL,
  currency payment_token NOT NULL,
  tx_signature VARCHAR(88),
  status purchase_status DEFAULT 'confirmed',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT unique_agent_purchase UNIQUE (agent_id, skill_id)
);
```

## 5. API 设计

### 5.1 Agent API

| 方法 | 端点 | 描述 |
|------|------|------|
| POST | `/api/agents/register` | Agent 注册 |
| POST | `/api/agents/claim` | 认领 Agent |
| GET | `/api/agents/me` | 获取当前 Agent |
| GET | `/api/agents/:id/balance` | 查询余额 |
| GET | `/api/agents/:id/purchases` | 购买记录 |

### 5.2 Skills API (Agent 专用)

| 方法 | 端点 | 描述 |
|------|------|------|
| GET | `/api/agent/skills` | 获取可用技能 |
| GET | `/api/agent/skills/:id` | 技能详情 |
| GET | `/api/agent/skills/:id/content` | 技能内容 |
| POST | `/api/purchases` | 自动购买技能 |

### 5.3 API 响应格式

```typescript
// 成功响应
interface ApiResponse<T> {
  success: true;
  data: T;
}

// 错误响应
interface ApiError {
  success: false;
  error: {
    code: string;
    message: string;
  };
}
```

## 6. 认证架构

### Agent API Key 认证

```typescript
// middleware.ts
import { agentAuthMiddleware } from '@awa/auth';

export const GET = agentAuthMiddleware(async (req, { agent }) => {
  // agent 已验证
  // agent.walletPublicKey 可用
  return Response.json({ agent });
});
```

### API Key 验证流程

```
1. 请求携带 X-Agent-Key header
2. 提取 API Key 前缀
3. 查询匹配的 Agent
4. 验证完整 Key hash
5. 更新 lastSeenAt
6. 返回 Agent 信息
```

## 7. 支付架构

### Agent 自动支付流程

```
1. Agent 请求购买技能
2. 验证 Agent API Key
3. 检查是否已购买
4. 获取技能价格
5. 解密 Agent 钱包私钥
6. 构建 Solana 交易
7. 签名并提交
8. 等待确认
9. 记录购买
10. 返回技能内容
```

## 8. 部署架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         Vercel                                   │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────────┐ │
│  │   Edge CDN     │  │  Edge Runtime  │  │    Serverless      │ │
│  │  (Static)      │  │  (Middleware)  │  │    Functions       │ │
│  └────────────────┘  └────────────────┘  └────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
          │                    │                    │
          ▼                    ▼                    ▼
┌─────────────────┐   ┌─────────────────┐
│   Supabase      │   │   Solana RPC    │
│   (Postgres)    │   │   (Helius)      │
└─────────────────┘   └─────────────────┘
```

## 9. CI/CD

### GitHub Actions (测试)

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
      - run: pnpm install
      - run: pnpm lint
      - run: pnpm test
```

### Vercel 自动部署

- main 分支推送 → Production 部署
- PR 创建 → Preview 部署

## 10. 安全考虑

### 10.1 API 安全
- Rate Limiting
- API Key Hash 存储
- Input Validation (Zod)

### 10.2 钱包安全
- 私钥 AES-256-GCM 加密存储
- 仅服务端解密
- 用完立即清除内存

### 10.3 智能合约交互
- 交易验证
- 错误处理和重试
