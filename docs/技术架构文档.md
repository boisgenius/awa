# 技术架构文档

## 1. 系统架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                         Client Layer                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   Browser   │  │   Mobile    │  │      AI Agent           │  │
│  │   (React)   │  │   (PWA)     │  │   (API Consumer)        │  │
│  └──────┬──────┘  └──────┬──────┘  └───────────┬─────────────┘  │
└─────────┼────────────────┼─────────────────────┼────────────────┘
          │                │                     │
          ▼                ▼                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Application Layer                           │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                    Next.js 14 (App Router)                  │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────┐ │ │
│  │  │  Pages   │  │   API    │  │  Server  │  │   Static   │ │ │
│  │  │  (RSC)   │  │  Routes  │  │ Actions  │  │   Assets   │ │ │
│  │  └──────────┘  └──────────┘  └──────────┘  └────────────┘ │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
          │                │                     │
          ▼                ▼                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Service Layer                              │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────────────────┐ │
│  │   Supabase   │  │   Solana     │  │      Supabase          │ │
│  │  (Database)  │  │  (Payments)  │  │      (Storage)         │ │
│  └──────────────┘  └──────────────┘  └────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 技术栈详情

### 2.1 前端技术

| 技术 | 版本 | 用途 |
|------|------|------|
| Next.js | 14.x | React 框架，SSR/SSG |
| React | 18.x | UI 库 |
| TypeScript | 5.x | 类型安全 |
| Tailwind CSS | 3.x | 样式系统 |
| Radix UI | latest | 无障碍组件原语 |
| Framer Motion | latest | 动画库 |
| Zustand | 4.x | 状态管理 |
| TanStack Query | 5.x | 服务端状态管理 |

### 2.2 区块链集成

| 技术 | 用途 |
|------|------|
| @solana/web3.js | Solana 链交互 |
| @solana/wallet-adapter | 钱包连接 |
| viem | Base 链交互 |
| wagmi | EVM 钱包适配 |

### 2.3 后端服务

| 服务 | 用途 |
|------|------|
| Supabase | 数据库 + 认证 + 实时订阅 + 存储 |
| Vercel | 部署 + Edge Functions |

### 2.4 测试工具

| 工具 | 用途 |
|------|------|
| Vitest | 单元测试 |
| Testing Library | 组件测试 |
| Playwright | E2E 测试 |
| MSW | API Mocking |

## 3. 目录结构

```
claw-academy/
├── src/
│   ├── app/                      # Next.js App Router
│   │   ├── (marketing)/          # 营销页面组
│   │   │   ├── page.tsx          # 首页
│   │   │   └── layout.tsx
│   │   ├── (dashboard)/          # 用户面板组
│   │   │   ├── marketplace/      # 市场
│   │   │   ├── leaderboard/      # 排行榜
│   │   │   └── settings/         # 设置
│   │   ├── api/                  # API 路由
│   │   │   ├── skills/
│   │   │   ├── users/
│   │   │   └── payments/
│   │   ├── layout.tsx            # 根布局
│   │   └── globals.css           # 全局样式
│   │
│   ├── components/
│   │   ├── ui/                   # 基础 UI 组件
│   │   │   ├── button/
│   │   │   │   ├── button.tsx
│   │   │   │   ├── button.test.tsx
│   │   │   │   └── index.ts
│   │   │   ├── card/
│   │   │   ├── badge/
│   │   │   ├── input/
│   │   │   └── ...
│   │   │
│   │   ├── layout/               # 布局组件
│   │   │   ├── sidebar/
│   │   │   ├── header/
│   │   │   └── footer/
│   │   │
│   │   └── features/             # 功能组件
│   │       ├── skill-card/
│   │       ├── skill-grid/
│   │       ├── leaderboard-table/
│   │       ├── token-widget/
│   │       ├── wallet-connect/
│   │       └── search-box/
│   │
│   ├── hooks/                    # 自定义 Hooks
│   │   ├── use-skills.ts
│   │   ├── use-wallet.ts
│   │   ├── use-search.ts
│   │   └── use-filters.ts
│   │
│   ├── lib/                      # 工具库
│   │   ├── utils.ts              # 通用工具函数
│   │   ├── cn.ts                 # className 合并
│   │   ├── api.ts                # API 客户端
│   │   └── constants.ts          # 常量定义
│   │
│   ├── stores/                   # Zustand Store
│   │   ├── use-ui-store.ts
│   │   ├── use-filter-store.ts
│   │   └── use-cart-store.ts
│   │
│   ├── types/                    # TypeScript 类型
│   │   ├── skill.ts
│   │   ├── user.ts
│   │   └── api.ts
│   │
│   └── styles/                   # 样式
│       └── design-tokens.css     # CSS 变量
│
├── tests/
│   ├── unit/                     # 单元测试
│   ├── integration/              # 集成测试
│   └── e2e/                      # E2E 测试
│       ├── home.spec.ts
│       ├── marketplace.spec.ts
│       └── checkout.spec.ts
│
├── public/                       # 静态资源
├── .env.example                  # 环境变量模板
├── tailwind.config.ts
├── vitest.config.ts
├── playwright.config.ts
└── package.json
```

## 4. 数据模型

### 4.1 核心实体

```typescript
// types/skill.ts
interface Skill {
  id: string;
  name: string;
  author: Author;
  description: string;
  category: SkillCategory;
  status: 'live' | 'dev' | 'deprecated';
  priority: 'high' | 'medium' | 'emerging';
  price: number;           // SOL
  rating: number;          // 0-5
  downloads: number;
  verified: boolean;
  features: string[];
  content: string;         // 技能 Markdown 内容
  createdAt: Date;
  updatedAt: Date;
}

type SkillCategory =
  | 'research'
  | 'finance'
  | 'coding'
  | 'security'
  | 'creative'
  | 'comms';

interface Author {
  id: string;
  name: string;
  walletAddress: string;
  verified: boolean;
  skills: Skill[];
}

interface User {
  id: string;
  walletAddress: string;
  twitterHandle?: string;
  savedSkills: string[];
  purchasedSkills: string[];
  clawBalance: number;
  stakedAmount: number;
}
```

### 4.2 数据库 Schema (Supabase)

```sql
-- Skills 表
CREATE TABLE skills (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  author_id UUID REFERENCES authors(id),
  description TEXT,
  category skill_category NOT NULL,
  status skill_status DEFAULT 'dev',
  priority skill_priority DEFAULT 'medium',
  price DECIMAL(10, 4) NOT NULL,
  rating DECIMAL(2, 1) DEFAULT 0,
  downloads INTEGER DEFAULT 0,
  verified BOOLEAN DEFAULT false,
  features TEXT[],
  content TEXT,                      -- 技能 Markdown 内容
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Authors 表
CREATE TABLE authors (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wallet_address VARCHAR(44) UNIQUE NOT NULL,
  name VARCHAR(50),
  verified BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Users 表
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wallet_address VARCHAR(44) UNIQUE NOT NULL,
  twitter_handle VARCHAR(50),
  claw_balance DECIMAL(18, 8) DEFAULT 0,
  staked_amount DECIMAL(18, 8) DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Purchases 表
CREATE TABLE purchases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  skill_id UUID REFERENCES skills(id),
  price DECIMAL(10, 4) NOT NULL,
  payment_token VARCHAR(10) NOT NULL,
  tx_signature VARCHAR(88),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 5. API 设计

### 5.1 RESTful 端点

| 方法 | 端点 | 描述 |
|------|------|------|
| GET | `/api/skills` | 获取技能列表 |
| GET | `/api/skills/:id` | 获取技能详情 |
| GET | `/api/skills/trending` | 获取热门技能 |
| GET | `/api/leaderboard` | 获取排行榜 |
| POST | `/api/purchases` | 创建购买订单 |
| GET | `/api/users/:address` | 获取用户信息 |
| POST | `/api/users/:address/save` | 收藏技能 |

### 5.2 API 响应格式

```typescript
// 成功响应
interface ApiResponse<T> {
  success: true;
  data: T;
  meta?: {
    page: number;
    limit: number;
    total: number;
  };
}

// 错误响应
interface ApiError {
  success: false;
  error: {
    code: string;
    message: string;
    details?: unknown;
  };
}
```

## 6. 状态管理

### 6.1 Zustand Store 设计

```typescript
// stores/use-filter-store.ts
interface FilterState {
  category: SkillCategory | 'all';
  status: 'all' | 'live' | 'dev';
  sortBy: 'trending' | 'newest' | 'price-low' | 'price-high';
  verifiedOnly: boolean;
  searchQuery: string;

  // Actions
  setCategory: (category: SkillCategory | 'all') => void;
  setStatus: (status: 'all' | 'live' | 'dev') => void;
  setSortBy: (sort: FilterState['sortBy']) => void;
  toggleVerifiedOnly: () => void;
  setSearchQuery: (query: string) => void;
  reset: () => void;
}
```

### 6.2 TanStack Query 使用

```typescript
// hooks/use-skills.ts
export function useSkills(filters: FilterState) {
  return useQuery({
    queryKey: ['skills', filters],
    queryFn: () => fetchSkills(filters),
    staleTime: 1000 * 60 * 5, // 5 minutes
  });
}

export function useSkillDetail(id: string) {
  return useQuery({
    queryKey: ['skill', id],
    queryFn: () => fetchSkillById(id),
    enabled: !!id,
  });
}
```

## 7. 测试策略

### 7.1 测试金字塔

```
        ╱╲
       ╱  ╲        E2E Tests (Playwright)
      ╱────╲       - 关键用户流程
     ╱      ╲      - 购买流程、钱包连接
    ╱────────╲
   ╱          ╲    Integration Tests
  ╱────────────╲   - API 路由测试
 ╱              ╲  - 组件集成测试
╱────────────────╲
       Unit Tests (Vitest)
  - 工具函数、Hooks、组件单元
```

### 7.2 测试文件命名约定

```
component.tsx        # 组件实现
component.test.tsx   # 单元测试
component.spec.ts    # E2E 测试 (Playwright)
```

### 7.3 测试覆盖率目标

| 类型 | 覆盖率目标 |
|------|-----------|
| Statements | >= 80% |
| Branches | >= 75% |
| Functions | >= 80% |
| Lines | >= 80% |

## 8. 部署架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         Vercel                                   │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────────┐ │
│  │   Edge CDN     │  │  Edge Runtime  │  │    Serverless      │ │
│  │  (Static)      │  │  (Middleware)  │  │    Functions       │ │
│  └────────────────┘  └────────────────┘  └────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
          │                    │                    │
          ▼                    ▼                    ▼
┌─────────────────┐   ┌─────────────────┐
│   Supabase      │   │   Solana RPC    │
│   (Postgres)    │   │   (Helius)      │
└─────────────────┘   └─────────────────┘
```

## 9. 安全考虑

### 9.1 前端安全
- 所有用户输入进行 XSS 防护
- CSP (Content Security Policy) 配置
- 敏感数据不存储在 localStorage

### 9.2 API 安全
- Rate Limiting
- 钱包签名验证
- Input Validation (Zod)

### 9.3 智能合约交互
- 交易预览和确认
- 滑点保护
- 错误处理和回滚

## 10. 性能优化

### 10.1 前端优化
- React Server Components 优先
- 图片使用 Next.js Image 优化
- 代码分割和懒加载
- 骨架屏加载状态

### 10.2 数据优化
- TanStack Query 缓存策略
- 分页和无限滚动
- 乐观更新

### 10.3 监控
- Vercel Analytics
- Error tracking (Sentry)
- Performance monitoring
